from langchain.chat_models import ChatOpenAI
from langchain.memory import ConversationBufferMemory
from langchain.chains import ConversationChain
from langchain.schema import HumanMessage

CHAT_PROMPT = """
당신은 다음 법령을 기준으로 사용자의 질문에 답합니다.
당신의 피드백은 다음과 같은 항목을 포함해야 합니다:
1. 사용자의 질문에 대한 답
2. 법적 근거
3. 도움을 받을 수 있는 전화번호

피드백은:
- 100자 이내여야 하고
- 한국어로 제시되어야 하며
- 문장을 나눌 땐 /n 을 사용해야 하며며
- 명료하고 직접적이며 공손한 표현을 사용해야 함.

** 법적 근거
충청북도교육청 지방보조금 관리 조례
[시행 2024. 4. 26.] [충청북도조례 제5093호, 2024. 4. 5., 일부개정]
충청북도교육청(예산과), 043-290-2137

 제1조(목적) 이 조례는 「지방자치단체 보조금 관리에 관한 법률」 및 같은 법 시행령에서 위임된 사항과 그 시행에 필요한 사항을 규정함을 목적으로 한다. 
 제2조(다른 조례와의 관계) 충청북도교육청(이하 “교육청”이라 한다) 지방보조금 관리에 관하여 다른 조례에 특별한 규정이 있는 경우를 제외하고는 이 조례에서 정하는 바에 따른다. 
 제3조(지방보조사업을 수행하려는 자의 예산 계상) 충청북도교육감(이하 “교육감”이라 한다)은 「지방자치단체 보조금 관리에 관한 법률」(이하 “법”이라 한다) 제5조제2항에 따라 지방보조금의 예산 계상 신청이 없는 경우에도 다음 각 호의 어느 하나에 해당하는 경우에는 지방보조금을 예산에 계상할 수 있다. 
1. 재난, 재해 등의 복구 및 예방을 위해 신속한 사업추진이 필요한 경우 
2. 국고보조금, 특별교부금 등 국가로부터 소요경비 전액을 교부하는 보조사업인 경우 
3. 그 밖에 교육감이 주요 시책 추진을 위하여 필요하다고 인정하는 경우 
 제4조(지방보조사업자 공모) ① 교육감은 공모방식을 통해 지방보조사업자를 선정하려는 경우에는 다음 각 호의 내용을 포함한 사업자 선정 공고문을 교육청 홈페이지 등을 통해 공고해야 한다.
1. 사업추진 기본방향 
2. 지원대상사업 
3. 지원사업 대상기관 및 응모방법 
4. 지원 및 선정절차 
5. 수행 일정 
6. 그 밖에 교육감이 게시가 필요하다고 인정하는 사항 
② 제1항의 보조사업자 선정 공고에 부합하는 보조사업자가 없는 경우에는 재공모해야 한다. 
③ 교육감은 지방보조사업자 공모 시 15일 이상의 접수 기간을 부여해야 한다. 다만, 다음 각 호의 어느 하나에 해당하는 경우에는 사업의 시급성 등을 고려하여 접수 기간을 조정할 수 있다. 
1. 재공모인 경우 
2. 국가 또는 교육청의 재정정책상 예산의 신속 집행을 위해 필요한 경우 
3. 국가사업 또는 교육청의 다른 사업과 연계되어 사업의 일정 조정을 위하여 불가피한 경우 
4. 긴급한 행사 또는 긴급한 재해 예방·복구 등을 위하여 필요한 경우 
 제5조(법령 위반 등에 따른 교부 결정의 취소) 교육감은 법 제12조제1항제4호에 따른 지방보조사업의 수행이 곤란한 경우로서 다음 각 호의 어느 하나에 해당하는 경우에는 지방보조금 교부 결정의 전부 또는 일부를 취소할 수 있다. 
1. 지방보조사업자가 교육감의 승인 없이 임의로 사업의 전부 또는 일부를 중지한 경우 
2. 지방보조사업에 소요되는 경비 중 지방보조금으로 충당되는 부분 외의 경비를 조달하지 못하는 경우 
3. 지방보조사업계획서의 예정된 토지 또는 그 밖의 시설을 이용할 수 없게 된 경우 
4. 지방보조사업의 추진이 공익에 어긋나 지방보조사업 내용의 변경 또는 중지가 필요하다고 인정되는 경우 
5. 법 제16조제5항에 따라 지방보조사업의 수행을 일시 정지하였음에도 시정하지 않아 더 이상 지방보조사업의 수행을 지속하기 어렵다고 판단되는 경우 
 제6조(중요재산의 보고 및 공시) ① 법 제21조제1항에 따른 중요재산의 현황 보고는 다음 각 호의 구분에 따른다. 다만, 제2호에 따른 보고의 경우 중요재산의 현황에 변동이 없는 경우에는 생략할 수 있다.
1. 취득 현황 보고: 중요재산 취득 후 15일 이내 
2. 변동 현황 보고: 매년 6월 및 12월 
② 「지방자치단체 보조금 관리에 관한 법률 시행령」(이하 “영”이라 한다) 제12조제2항에 따른 중요재산의 현황 보고는 별지 제1호서식에 따른다. 
③ 교육감은 영 제12조제3항에 따라 제1항에 따른 보고를 받은 날부터 30일 이내에 중요재산의 현황을 다음 각 호의 구분에 따른 기간 동안 교육청 홈페이지에 공시해야 한다. 
1. 부동산과 그 종물: 10년 
2. 선박, 부표, 부잔교, 부선거와 그 종물: 10년 
3. 항공기: 10년 
4. 그 밖의 기계, 장비 등 중요재산: 5년 
④ 교육감은 지방보조사업자로 하여금 중요재산 취득가액 및 시기, 사용 장소, 재정 지원 내용 등의 재산정보를 표기한 안내문 등을 부착하여 관리하게 할 수 있다. 
 제7조(중요재산의 부기등기) ① 지방보조사업자가 법 제22조제1항에 따라 부기등기를 할 때에는 별지 제2호서식의 지방보조금이 지원된 부동산 증명서를 관할 등기소에 제출해야 한다.
② 지방보조사업자가 법 제22조제4항에 따라 부기등기를 말소하고자 할 때에는 별지 제3호서식의 부기등기 말소 대상 부동산 증명서를 관할 등기소에 제출해야 한다. 
 제8조(신고 포상금 지급절차) ① 교육감은 법 제36조의3과 영 제21조의2에 따라 포상금을 지급하는 경우에는 신고 또는 고발한 자(이하 “신고인 등”이라 한다)에게 별지 제4호서식의 신청서 제출을 요청할 수 있다. <개정 2024. 4. 5.>
② 교육감은 다음 각 호의 어느 하나에 해당하는 경우에는 신고포상금을 지급하지 않을 수 있다. <신설 2024. 4. 5.>
1. 언론 등에 이미 공개된 내용인 경우 
2. 관계 행정관청이나 수사기관에서 사전 인지하여 조사 또는 수사 중인 경우 
3. 지방보조사업 및 지방보조사업자를 구체적으로 특정하지 않거나 내용이 불충분하여 확인이 곤란한 경우 
4. 신고인 등이 익명이나 가명 또는 타인의 명의로 신고 또는 고발한 경우 
5. 거짓이나 그 밖의 부정한 방법으로 신고 또는 고발한 경우 
③ 교육감은 법 제36조의3에 따라 지급된 포상금에 대하여 신고인 등이 다음 각 호의 어느 하나에 해당하는 경우에는 포상금의 전부 또는 일부를 환수해야 한다. <개정 2024. 4. 5.>
1. 허위, 그 밖의 부정한 방법으로 포상금을 지급받은 경우 
2. 그 밖에 착오 등의 사유로 포상금이 잘못 지급된 경우(다른 법령 등에 따라 동일한 사항에 대해 중복하여 지급한 경우를 포함한다) 
④ 포상금 지급에 관여한 심의 위원 또는 공무원은 신고인 등의 신원 또는 신고내용 등에 관하여 비밀을 유지해야 한다. 
⑤ 교육감은 신고포상금 지급과 관련하여 신고인 등의 신분, 신고내용 등이 외부에 공개된 경우에는 관련 사실을 조사하여 필요한 조치를 할 수 있다. 
⑥ 그 밖에 포상금의 지급기준과 방법 및 절차 등 세부적인 사항은 교육감이 별도로 정할 수 있다. 
 제9조(지방보조금관리위원회의 구성 등) ① 교육감은 법 제26조에 따라 교육청 지방보조금에 관한 사항을 심의하기 위하여 지방보조금관리위원회(이하 “위원회”라 한다)를 구성한다. <신설 2024. 4. 5.>
② 위원회 구성은 위원장 1명과 부위원장 1명을 포함하여 15명 이내의 위원으로 구성한다. 다만, 위촉직 위원의 경우에는 특정 성별이 위촉직 위원수의 10분의 6을 넘지 않도록 한다. <개정 2024. 4. 5.>
③ 위원장은 위촉직 위원 중에서, 부위원장은 전체 위원 중에서 각각 호선한다. 
④ 위원회의 위원(이하 “위원”이라 한다)은 다음 각 호의 사람 중에서 교육감이 임명 또는 위촉한다. <개정 2023. 11. 3., 2024. 4. 5.>
1. 교육청 본청 과장급 이상 공무원 
2. 지방보조금에 관한 전문지식이 있는 조교수 이상의 대학교수 
3. 정부나 지방자치단체의 출연기관에 소속된 박사학위 소지자로서 지방보조금에 관한 전문지식이 있는 사람 
4. 5년 이상의 실무경험이 있는 변호사·공인회계사·세무사 및 금융업무 전문가 
5. 학부모·시민단체 대표 
6. 3년 이상 근무경력을 가진 국가 및 다른 지방자치단체 공무원 
7. 그 밖에 지방보조금에 관한 전문지식과 경험이 풍부한 사람 
 제10조(위원의 임기) ① 위촉직 위원의 임기는 2년으로 하며, 한 차례만 연임할 수 있다.
② 위촉직 위원의 사임 등으로 새로 위촉된 위원의 임기는 전임위원 임기의 남은 기간으로 한다. 
③ 위촉직 위원은 제1항에 따른 임기가 만료된 경우에도 후임위원이 위촉될 때까지 그 직무를 수행할 수 있다. 
 제11조(위원장의 직무) ① 위원장은 위원회를 대표하고, 위원회의 업무를 총괄한다.
② 위원장이 부득이한 사유로 직무를 수행할 수 없을 때에는 부위원장이 그 직무를 대행하며, 위원장과 부위원장이 모두 부득이한 사유로 직무를 수행할 수 없을 때에는 위원장이 미리 지명한 위원이 그 직무를 대행한다. 
 제12조(위원회의 운영) 위원회는 법 제26조제2항제1호에 따라 지방보조금 예산을 편성할 때에는 예산편성 일정 등 여건을 고려하여 보조금 과목별·사업별 규모, 공모 대상 보조금 규모, 보조사업 유형별 재원 분담의 적정성 여부 등을 심의할 수 있다. <개정 2024. 4. 5.>
 제13조(위원회 회의) ① 위원장은 위원회의 회의를 소집하고, 그 의장이 된다.
② 위원회의 회의는 재적위원 과반수의 출석으로 개의하고, 출석위원 과반수의 찬성으로 의결한다. 
③ 삭제 <2024. 4. 5.>
④ 위원장은 「충청북도교육청 각종 위원회 설치 및 운영 조례」 제12조제2항 각 호의 어느 하나에 해당하는 경우에는 서면으로 심의를 할 수 있다. 이 경우 재적위원 과반수의 서면심의서 제출과 제출한 위원 과반수의 찬성으로 의결한다. <개정 2024. 4. 5.>
 제14조(분과위원회) ① 위원회는 효율적인 운영을 위하여 별도로 분과위원회를 구성하여 운영할 수 있다.
② 분과위원회 심의·의결사항은 위원회에 총괄 보고하고, 위원회에서 최종 결정하되 그 절차를 간소화할 수 있다. 
③ 분과위원회의 설치 및 운영 등에 필요한 사항은 위원회의 의결을 거쳐 위원장이 정한다. 
 제15조(의견 청취 등) 위원회는 업무수행을 위하여 필요한 경우 관계 공무원 및 지방보조사업자 등을 회의에 참석하게 하여 그 의견을 듣거나 관계 기관 또는 단체 등에 관련 자료를 요청할 수 있다. 
 제16조(간사) 위원회의 사무 처리를 위하여 간사 1명을 두며, 간사는 예산담당 사무관이 된다. 
 제17조(회의록) 교육감은 회의를 개최한 때에는 다음 각 호의 사항을 기재한 회의록을 작성하여 갖추어 두어야 한다. 다만, 서면심의의 경우에는 예외로 한다. <개정 2024. 4. 5.>
1. 회의 개최 일시 및 장소 
2. 회의 참석 위원의 성명 
3. 회의 심의 사항 
4. 그 밖에 위원장이 중요하다고 인정하는 사항 
 제18조(실비보상) 위원회 및 분과위원회에 참석한 위원 중 위촉직 위원에 대하여는 예산의 범위에서 「충청북도 교육·학예에 관한 각종 위원회 실비변상 조례」에 따라 수당과 여비를 지급할 수 있다. 
 제19조(운영세칙) 이 조례에서 규정한 것 이외에 위원회 운영에 관하여 필요한 사항은 위원회의 의결을 거쳐 위원장이 따로 정한다. 
 제20조(지방보조사업 내역의 공시) ① 교육감은 지방보조금의 교부현황, 성과평가 결과, 지방보조금으로 취득한 중요재산의 변동현황, 교부결정의 취소 등 중요 처분 내용에 대해 주민에게 공시해야 한다.
② 제1항의 공시에 관한 세부적인 사항은 교육부장관이 별도로 정하는 재정공시에 관한 기준에 따른다. 
부칙<제3790호,2015.5.15.>펼침  부      칙 <제3790호,2015.5.15.> 부칙<제3790호,2015.5.15.>보기
제1조(시행일) 이 조례는 공포한 날부터 시행한다. 다만, 제4조제3호의 개정규정은 2016회계연도에 지방보조금 지출을 하는 경우부터 적용한다.
제2조(경과조치) 이 조례 시행일 이전에 교부된 지방보조금에 대해서는 종전의 규정에 따른다.
제3조(다른 조례의 개정) ① 충청북도 교복나눔운동 지원에 관한 조례 일부를 다음과 같이 개정한다.
제6조제2항 중 “「충청북도교육비특별회계 보조금 관리 조례」”를 “「충청북도교육비특별회계 지방보조금 관리 조례」”로 한다.
② 충청북도교육청 평생교육 운영 및 지원에 관한 조례 일부를 다음과 같이 개정한다.
제5조제1항 및 제2항 중 “보조금”을 각각 “지방보조금”으로 하고, 같은 조 제2항 중 “「충청북도교육비특별회계 보조금 관리 조례」”를 “「충청북도교육비특별회계 지방보조금 관리 조례」”로 한다.
부칙<제3947호,2016.7.29.>(충청북도교육청 행정기구 설치 조례)펼침  부      칙 <제3947호,2016.7.29.>(충청북도교육청 행정기구 설치 조례) 부칙<제3947호,2016.7.29.>(충청북도교육청 행정기구 설치 조례)보기
제1조(시행일) 이 조례는 2016년 9월 1일부터 시행한다.
제2조(유효기간) (생략)
제3조(다른 조례의 개정) ① ~ ② (생략)
③ 충청북도교육비특별회계 지방보조금 관리 조례 일부를 다음과 같이 개정한다.
제6조제4항제1호 중 "행정관리국장"을 "행정국장"으로 한다.
④ ~ ⑩ (생략)
부칙<제4198호,2018.11.9.>(충청북도교육비특별회계 소관 공유재산 관리 조례)펼침  부      칙 <제4198호,2018.11.9.>(충청북도교육비특별회계 소관 공유재산 관리 조례) 부칙<제4198호,2018.11.9.>(충청북도교육비특별회계 소관 공유재산 관리 조례)보기
제1조(시행일) 이 조례는 공포한 날부터 시행한다.
제3조(다른 조례의 개정) 충청북도교육비특별회계 지방보조금 관리 조례 일부를 다음과 같이 개정한다.
제5조제3항 중 “행정자치부”를 “행정안전부”로 한다.
부칙<제4228호,2019.2.8.>(충청북도교육청 행정기구 설치 조례)펼침  부      칙 <제4228호,2019.2.8.>(충청북도교육청 행정기구 설치 조례) 부칙<제4228호,2019.2.8.>(충청북도교육청 행정기구 설치 조례)보기
제1조(시행일) 이 조례는 2019년 3월 1일부터 시행한다. <단서 생략>
제2조(다른 조례의 개정) ① ~ ⑫ 생략
⑬ 충청북도교육비특별회계 지방보조금 관리 조례 일부를 다음과 같이 개정한다.
제6조제4항제1호 중 “기획관”을 “기획국장”으로 한다.
⑭ ~ ⑮ 생략
부칙<제4776호, 2022. 7. 8.>펼침  부      칙 <제4776호, 2022. 7. 8.> 부칙<제4776호, 2022. 7. 8.>보기
제1조(시행일) 이 조례는 공포한 날부터 시행한다.
제2조(일반적 경과조치) 이 조례 시행 당시 종전의「충청북도교육비특별회계 지방보조금 관리 조례」에 따른 행정기관의 행위나 행정기관에 대한 행위는 그에 해당하는 이 조례에 따른 행정기관의 행위나 행정기관에 대한 행위로 본다.
제3조(지방보조금심의위원회에 대한 경과조치) ① 이 조례 시행 당시 종전의 조례에 따른 충청북도교육청 지방보조금심의위원회는 이 조례에 따라 구성된 충청북도교육청 지방보조금관리위원회로 본다.
② 이 조례 시행 당시 종전의 조례에 따라 임명되거나 위촉된 충청북도교육청 지방보조금심의위원회의 위원은 이 조례에 따라 충청북도교육청 지방보조금관리위원회의 위원으로 임명되거나 위촉된 것으로 본다.
제4조(다른 조례의 개정) ① 충청북도 교복나눔운동 지원에 관한 조례 일부를 다음과 같이 개정한다.
제6조제2항 중 “충청북도교육비특별회계 지방보조금 관리 조례”를 “충청북도교육청 지방보조금 관리 조례”로 한다.
② 충청북도교육청 각종 기념행사 지방보조금 지원에 관한 조례 일부를 다음과 같이 개정한다.
제6조 중 “충청북도교육비특별회계 지방보조금 관리 조례”를 “충청북도교육청 지방보조금 관리 조례”로 한다.
③ 충청북도교육청 교직원단체 보조금 지원 등에 관한 조례 일부를 다음과 같이 개정한다.
제6조 중 “충청북도교육비특별회계 지방보조금 관리 조례”를 “충청북도교육청 지방보조금 관리 조례”로 한다.
④ 충청북도교육청 독립유공자 선양 행사 지원 조례 일부를 다음과 같이 개정한다.
제2조제3호 중 “「충청북도교육비특별회계 지방보조금 관리 조례」제2조제1호”를 “「지방자치단체 보조금 관리에 관한 법률」 제2조제1호”로 한다.
제5조 중 “충청북도교육비특별회계 지방보조금 관리 조례”를 “충청북도교육청 지방보조금 관리 조례”로 한다.
⑤ 충청북도교육청 언론을 통한 소통 활성화 지원 조례 일부를 다음과 같이 개정한다.
제2조제3호 중 “「충청북도교육비특별회계 지방보조금 관리 조례」제2조제1호”를 “「지방자치단체 보조금 관리에 관한 법률」 제2조제1호”로 한다.
제5조 중 “충청북도교육비특별회계 지방보조금 관리 조례”를 “충청북도교육청 지방보조금 관리 조례”로 한다.
⑥ 충청북도교육청 장애인 평생교육시설 지원 조례 일부를 다음과 같이 개정한다.
제5조 중 “충청북도교육비특별회계 지방보조금 관리 조례”를 “충청북도교육청 지방보조금 관리 조례”로 한다.
⑦ 충청북도교육청 평생교육 운영 및 지원에 관한 조례 일부를 다음과 같이 개정한다.
제5조제2항 중 “충청북도교육비특별회계 지방보조금 관리 조례”를 “충청북도교육청 지방보조금 관리 조례”로 한다.
⑧ 충청북도교육청 학생 체육대회 지원 조례 일부를 다음과 같이 개정한다.
제7조 중 “충청북도교육비특별회계 지방보조금 관리 조례”를 “충청북도교육청 지방보조금 관리 조례”로 한다.
⑨ 충청북도 마을교육공동체 활성화 지원에 관한 조례 일부를 다음과 같이 개정한다.
제6조제1항 중 “충청북도교육비특별회계 지방보조금 관리 조례”를 “충청북도교육청 지방보조금 관리 조례”로 한다.
부칙<제5025호, 2023. 11. 3.>(충청북도교육청 통합재정안정화기금 설치 및 운용 조례)펼침  부      칙 <제5025호, 2023. 11. 3.>(충청북도교육청 통합재정안정화기금 설치 및 운용 조례) 부칙<제5025호, 2023. 11. 3.>(충청북도교육청 통합재정안정화기금 설치 및 운용 조례)보기
제1조(시행일) 이 조례는 공포한 날부터 시행한다. 다만, ···<생략>···, 부칙 제2조는 2024년 1월 1일부터 시행한다.
제2조(다른 조례의 개정) ①부터 ②까지 생략
③ 충청북도교육청 지방보조금 관리 조례 일부를 다음과 같이 개정한다.
제9조제3항제1호 중 “행정국장”을 “행정국장, 예산과장”으로 한다.
④부터 ⑥까지 생략
]
"""

memory = ConversationBufferMemory(k=6, return_messages=True)   # remember up to 3 messages (better user experience:)

# LLM Model
llm = ChatOpenAI(model_name="gpt-4o", temperature=0.7)  # or "gpt-4.5-turbo"
conversation = ConversationChain(llm=llm, memory=memory)

def get_today_tip():
    response = conversation.predict(input="보조금 수급자에게 재정 팁 하나만 한 줄로 보여줘.")
    return response

def get_chat_response(message):
    full_prompt = CHAT_PROMPT.strip() + "\n\nuser question: " + message
    response = conversation.predict(input=full_prompt)
    return response

def get_chat_history(user_id):
    # 예시 데이터
    return [{"user": "이번 달 예산이 부족해요.", "bot": "지출을 검토해보고 가장 큰 항목을 줄여보세요."}]
